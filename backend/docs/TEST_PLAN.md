# OpenFinance 完整测试计划

## 一、测试概述

### 1.1 测试目标
验证 OpenFinance 智能金融分析平台的以下核心功能：
- 数据中心：数据采集、存储、服务
- 数据源管理：多数据源配置、健康检查
- 数据服务：API 接口、数据查询
- 数据链路：任务调度、DAG 执行
- 知识图谱：实体搜索、多跳查询
- 量化分析：因子计算、策略开发
- 回测评测：策略回测、绩效评估

### 1.2 测试环境
- 数据库：PostgreSQL (openfinance schema)
- 后端：FastAPI (端口 8000)
- 前端：React (端口 3001)
- 数据量：2年历史数据，5000+ 股票

---

## 二、数据中心测试

### 2.1 数据采集测试

| 测试项 | 测试内容 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| TC-DC-001 | 股票基础信息采集 | 成功获取 5000+ 股票基础信息 | P0 |
| TC-DC-002 | 股票日线行情采集 | 成功获取最近交易日全部股票行情 | P0 |
| TC-DC-003 | 指数行情采集 | 成功获取主要指数 K 线数据 | P0 |
| TC-DC-004 | 北向资金采集 | 成功获取北向资金流向数据 | P1 |
| TC-DC-005 | 行业板块采集 | 成功获取行业板块行情数据 | P1 |
| TC-DC-006 | 概念板块采集 | 成功获取概念板块行情数据 | P1 |
| TC-DC-007 | 宏观经济数据采集 | 成功获取 GDP/CPI/PMI 等数据 | P1 |
| TC-DC-008 | 财经新闻采集 | 成功获取最新财经新闻 | P2 |

### 2.2 交易日历测试

| 测试项 | 测试内容 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| TC-TC-001 | 交易日判断 | 正确识别交易日和非交易日 | P0 |
| TC-TC-002 | 周末过滤 | 周六、周日不执行采集任务 | P0 |
| TC-TC-003 | 节假日过滤 | 春节等法定节假日不执行采集 | P0 |
| TC-TC-004 | 获取最近交易日 | 正确返回最近的交易日 | P0 |
| TC-TC-005 | 获取交易日列表 | 正确返回指定范围内的交易日列表 | P1 |

### 2.3 数据存储测试

| 测试项 | 测试内容 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| TC-DS-001 | 股票行情存储 | 正确存储 OHLCV 数据 | P0 |
| TC-DS-002 | 因子数据存储 | 正确存储因子计算结果 | P0 |
| TC-DS-003 | 数据去重 | 相同日期股票数据不重复 | P0 |
| TC-DS-004 | 数据更新 | 正确更新已有数据 | P1 |
| TC-DS-005 | 批量插入性能 | 5000 股票数据插入 < 30s | P1 |

---

## 三、数据源管理测试

### 3.1 数据源配置测试

| 测试项 | 测试内容 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| TC-SRC-001 | 东方财富数据源 | 正确配置和连接东方财富 API | P0 |
| TC-SRC-002 | 金十数据源 | 正确配置和连接金十数据 API | P1 |
| TC-SRC-003 | 财联社数据源 | 正确配置和连接财联社 API | P1 |
| TC-SRC-004 | YAML 配置加载 | 正确从配置文件加载数据源 | P0 |
| TC-SRC-005 | 数据源健康检查 | 正确检测数据源可用性 | P1 |

### 3.2 数据源切换测试

| 测试项 | 测试内容 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| TC-SW-001 | 主数据源故障切换 | 主数据源故障时自动切换备用 | P1 |
| TC-SW-002 | 数据源优先级 | 按配置优先级选择数据源 | P2 |

---

## 四、数据服务测试

### 4.1 K 线数据服务测试

| 测试项 | API 端点 | 测试内容 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| TC-KL-001 | GET /api/dataservice/v1/market/kline/{code} | 获取单只股票 K 线 | 返回完整 OHLCV 数据 | P0 |
| TC-KL-002 | GET /api/dataservice/v1/market/kline/{code}?period=week | 获取周 K 线 | 返回周线数据 | P1 |
| TC-KL-003 | GET /api/dataservice/v1/market/kline/{code}?start_date=&end_date= | 按日期范围查询 | 返回指定范围数据 | P0 |
| TC-KL-004 | GET /api/dataservice/v1/market/kline/{code}?limit=100 | 限制返回数量 | 返回最近 100 条 | P1 |

### 4.2 财务数据服务测试

| 测试项 | API 端点 | 测试内容 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| TC-FIN-001 | GET /api/dataservice/v1/market/financial/{code} | 获取财务指标 | 返回 PE/PB/ROE 等 | P0 |
| TC-FIN-002 | GET /api/dataservice/v1/analysis/company/{code} | 获取公司洞察 | 返回公司分析数据 | P1 |

### 4.3 宏观数据服务测试

| 测试项 | API 端点 | 测试内容 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| TC-MAC-001 | GET /api/dataservice/v1/analysis/macro | 获取宏观经济指标 | 返回 GDP/CPI/PMI | P1 |
| TC-MAC-002 | GET /api/dataservice/v1/analysis/macro?indicator=gdp | 按指标查询 | 返回指定指标数据 | P2 |

---

## 五、数据链路测试

### 5.1 DAG 任务调度测试

| 测试项 | 测试内容 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| TC-DAG-001 | DAG 配置加载 | 正确加载 pipelines.yaml 配置 | P0 |
| TC-DAG-002 | 任务执行 | 任务按依赖顺序正确执行 | P0 |
| TC-DAG-003 | 任务失败重试 | 失败任务自动重试 | P1 |
| TC-DAG-004 | 任务超时处理 | 超时任务正确终止 | P1 |
| TC-DAG-005 | 并发任务控制 | 正确控制并发任务数 | P2 |

### 5.2 Pipeline API 测试

| 测试项 | API 端点 | 测试内容 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| TC-PL-001 | GET /api/pipeline/dags | 获取所有 DAG | 返回 DAG 列表 | P0 |
| TC-PL-002 | POST /api/pipeline/dags/load-config | 加载 DAG 配置 | 成功加载配置 | P0 |
| TC-PL-003 | POST /api/pipeline/dags/{dag_id}/execute | 执行 DAG | 成功执行任务 | P0 |
| TC-PL-004 | GET /api/pipeline/dags/{dag_id}/status | 获取执行状态 | 返回执行状态 | P1 |

---

## 六、知识图谱测试

### 6.1 实体搜索测试

| 测试项 | API 端点 | 测试内容 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| TC-KG-001 | GET /api/graph/entities?search=平安 | 搜索实体 | 返回匹配的实体列表 | P0 |
| TC-KG-002 | GET /api/graph/entities?type=stock | 按类型筛选 | 返回股票类型实体 | P0 |
| TC-KG-003 | GET /api/graph/entity/{id} | 获取实体详情 | 返回实体完整信息 | P0 |
| TC-KG-004 | GET /api/graph/entity/{id}?depth=2 | 获取关联图谱 | 返回 2 层关联关系 | P1 |

### 6.2 多跳查询测试

| 测试项 | API 端点 | 测试内容 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| TC-MH-001 | GET /api/graph/path?from=A&to=B | 两点间路径 | 返回最短路径 | P0 |
| TC-MH-002 | GET /api/graph/path?from=A&to=B&max_hops=3 | 限制跳数 | 返回 3 跳内路径 | P1 |
| TC-MH-003 | GET /api/graph/path?from=A&relation_type=competes_with | 按关系类型查询 | 返回指定关系路径 | P1 |

### 6.3 图谱统计测试

| 测试项 | API 端点 | 测试内容 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| TC-GS-001 | GET /api/graph/stats | 获取图谱统计 | 返回实体/关系数量 | P1 |
| TC-GS-002 | GET /api/graph/quality | 获取数据质量 | 返回质量报告 | P2 |

---

## 七、量化分析测试

### 7.1 因子计算测试

| 测试项 | 测试内容 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| TC-FC-001 | 动量因子计算 | 正确计算价格动量 | P0 |
| TC-FC-002 | 波动率因子计算 | 正确计算历史波动率 | P0 |
| TC-FC-003 | RSI 因子计算 | 正确计算 RSI 指标 | P0 |
| TC-FC-004 | MACD 因子计算 | 正确计算 MACD 指标 | P0 |
| TC-FC-005 | KDJ 因子计算 | 正确计算 KDJ 指标 | P0 |
| TC-FC-006 | 布林带因子计算 | 正确计算布林带 | P0 |
| TC-FC-007 | ATR 因子计算 | 正确计算 ATR | P1 |
| TC-FC-008 | 因子批量计算 | 批量计算 5000 股票因子 | P0 |
| TC-FC-009 | 因子数据存储 | 计算结果正确存入数据库 | P0 |

### 7.2 因子 API 测试

| 测试项 | API 端点 | 测试内容 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| TC-FA-001 | GET /api/factors/list | 获取因子列表 | 返回所有注册因子 | P0 |
| TC-FA-002 | GET /api/factors/registry | 获取因子注册表 | 返回因子详细信息 | P0 |
| TC-FA-003 | GET /api/factors/{factor_id} | 获取因子详情 | 返回因子元数据 | P0 |
| TC-FA-004 | GET /api/factors/{factor_id}/code | 获取因子源码 | 返回因子代码 | P1 |
| TC-FA-005 | POST /api/factors/data/query | 查询因子数据 | 返回历史因子值 | P0 |
| TC-FA-006 | POST /api/factors/calculate | 计算因子值 | 返回计算结果 | P0 |
| TC-FA-007 | POST /api/factors/test | 测试因子性能 | 返回 IC 等指标 | P1 |

### 7.3 因子数据查询测试

| 测试项 | 测试内容 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| TC-FQ-001 | 单股票因子查询 | 正确返回指定股票因子数据 | P0 |
| TC-FQ-002 | 多股票因子查询 | 正确返回多股票因子数据 | P0 |
| TC-FQ-003 | 日期范围查询 | 正确返回指定日期范围数据 | P0 |
| TC-FQ-004 | 因子标准化 | 正确计算标准化值 | P1 |
| TC-FQ-005 | 数据库优先查询 | 优先从数据库加载已计算数据 | P0 |

---

## 八、策略开发测试

### 8.1 策略创建测试

| 测试项 | API 端点 | 测试内容 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| TC-ST-001 | POST /api/strategies/create | 创建单因子策略 | 成功创建策略 | P0 |
| TC-ST-002 | POST /api/strategies/create | 创建多因子策略 | 成功创建策略 | P0 |
| TC-ST-003 | POST /api/strategies/create | 设置因子权重 | 正确应用权重配置 | P1 |
| TC-ST-004 | POST /api/strategies/create | 设置风控参数 | 正确应用风控配置 | P1 |

### 8.2 策略运行测试

| 测试项 | API 端点 | 测试内容 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| TC-SR-001 | POST /api/strategies/run | 运行策略生成信号 | 返回股票推荐列表 | P0 |
| TC-SR-002 | POST /api/strategies/run | 指定股票池运行 | 正确筛选股票 | P0 |
| TC-SR-003 | POST /api/strategies/run | 获取 Top N 推荐 | 返回前 N 只股票 | P1 |
| TC-SR-004 | GET /api/strategies/{id}/signals | 获取策略信号 | 返回历史信号 | P1 |

### 8.3 策略 API 测试

| 测试项 | API 端点 | 测试内容 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| TC-SA-001 | GET /api/strategies/list | 获取策略列表 | 返回所有策略 | P0 |
| TC-SA-002 | GET /api/strategies/registry | 获取策略注册表 | 返回策略详情 | P0 |
| TC-SA-003 | GET /api/strategies/{id} | 获取策略详情 | 返回策略配置 | P0 |

---

## 九、回测评测测试

### 9.1 回测引擎测试

| 测试项 | 测试内容 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| TC-BT-001 | 单因子策略回测 | 正确执行回测 | P0 |
| TC-BT-002 | 多因子策略回测 | 正确执行回测 | P0 |
| TC-BT-003 | 回测日期范围 | 正确处理日期边界 | P0 |
| TC-BT-004 | 交易成本计算 | 正确计算手续费 | P1 |
| TC-BT-005 | 滑点模拟 | 正确模拟滑点 | P1 |

### 9.2 绩效指标测试

| 测试项 | 测试内容 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| TC-PM-001 | 年化收益率计算 | 正确计算年化收益 | P0 |
| TC-PM-002 | 最大回撤计算 | 正确计算最大回撤 | P0 |
| TC-PM-003 | 夏普比率计算 | 正确计算夏普比率 | P0 |
| TC-PM-004 | 胜率计算 | 正确计算胜率 | P1 |
| TC-PM-005 | 盈亏比计算 | 正确计算盈亏比 | P1 |

### 9.3 归因分析测试

| 测试项 | 测试内容 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| TC-AT-001 | 因子归因分析 | 正确分解因子贡献 | P1 |
| TC-AT-002 | 行业归因分析 | 正确分解行业贡献 | P1 |
| TC-AT-003 | 风险归因分析 | 正确分解风险来源 | P2 |

---

## 十、集成测试场景

### 10.1 端到端数据流测试

```
场景：完整数据采集到因子计算流程

步骤：
1. 执行股票基础信息采集
2. 执行股票日线行情采集
3. 验证数据存储完整性
4. 执行因子计算任务
5. 验证因子数据正确性
6. 查询因子数据 API
7. 验证前端展示正确

预期：全流程无错误，数据完整
```

### 10.2 策略开发到回测流程

```
场景：完整策略开发和回测流程

步骤：
1. 创建多因子策略
2. 配置因子权重
3. 运行策略生成信号
4. 执行策略回测
5. 查看绩效指标
6. 分析归因报告

预期：全流程无错误，结果合理
```

### 10.3 知识图谱查询流程

```
场景：知识图谱多跳查询

步骤：
1. 搜索目标实体
2. 获取实体关联图谱
3. 查询实体间路径
4. 分析关联关系

预期：查询结果准确，响应时间 < 1s
```

---

## 十一、性能测试

### 11.1 API 性能要求

| API 类型 | 响应时间要求 | 并发数 |
|----------|--------------|--------|
| 单条查询 | < 100ms | 100 |
| 列表查询 | < 500ms | 50 |
| 批量操作 | < 3s | 10 |
| 计算任务 | < 30s | 5 |

### 11.2 数据量性能要求

| 数据量 | 操作 | 时间要求 |
|--------|------|----------|
| 5000 股票 | 日行情采集 | < 5min |
| 5000 股票 × 14 因子 | 因子计算 | < 10min |
| 100 万条 | 数据查询 | < 1s |

---

## 十二、测试执行计划

### 12.1 测试阶段

| 阶段 | 内容 | 时间 |
|------|------|------|
| 第一阶段 | 数据中心、数据源管理测试 | Day 1 |
| 第二阶段 | 数据服务、数据链路测试 | Day 2 |
| 第三阶段 | 知识图谱测试 | Day 3 |
| 第四阶段 | 因子计算测试 | Day 4 |
| 第五阶段 | 策略开发、回测测试 | Day 5 |
| 第六阶段 | 集成测试、性能测试 | Day 6 |

### 12.2 测试工具

- API 测试：pytest + httpx
- 数据库测试：asyncpg
- 性能测试：locust
- 覆盖率：pytest-cov

### 12.3 测试报告

每个测试阶段完成后输出：
- 测试用例执行结果
- 发现的问题列表
- 性能指标报告
- 改进建议

---

## 十三、验收标准

### 13.1 功能验收

- [ ] 所有 P0 测试用例通过率 100%
- [ ] 所有 P1 测试用例通过率 95%+
- [ ] 所有 P2 测试用例通过率 90%+

### 13.2 性能验收

- [ ] API 响应时间满足要求
- [ ] 数据采集任务按时完成
- [ ] 因子计算任务按时完成

### 13.3 数据质量验收

- [ ] 数据完整性 99%+
- [ ] 数据准确性 99%+
- [ ] 数据及时性（T+1 数据当日完成）
