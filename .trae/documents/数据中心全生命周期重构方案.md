# 数据中心全生命周期重构方案

## 一、现有架构分析

### 1.1 核心模块现状

| 模块 | 位置 | 现状 | 问题 |
|------|------|------|------|
| 数据收集 | `collector/` | 有BaseCollector抽象、Orchestrator编排器 | 代码重复、配置硬编码 |
| 任务队列 | `task/` | 有TaskQueue、TaskChainEngine(DAG)、TriggerManager | 缺少持久化、分布式支持 |
| 数据存储 | `persistence.py` | 有批量插入、UPSERT策略 | 缺少数据质量校验、监控指标 |
| 数据服务 | `service/` | 有UnifiedDataService | 缓存机制简单、API未标准化 |
| 核心工具 | `core/` | 有converters、http_client、field_mapping | 工具未被充分利用 |

### 1.2 已有DAG能力

`TaskChainEngine` 已实现：
- DAG任务编排与验证
- 并行执行独立任务
- 条件分支支持
- 状态跟踪与持久化
- 故障处理与重试

---

## 二、重构目标架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           API Gateway Layer                                  │
│                    FastAPI Routes / WebSocket / MCP Server                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                           Orchestration Layer                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐  │
│  │  PipelineManager │  │  DAGScheduler   │  │    TriggerManager           │  │
│  │  - Pipeline定义   │  │  - 拓扑排序      │  │    - Cron/Interval/Event    │  │
│  │  - 依赖解析      │  │  - 并行调度      │  │    - 条件触发               │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────────────────┤
│                           Task Execution Layer                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                        TaskQueue (Priority-based)                        ││
│  │  - 并发控制  - 重试机制  - 检查点恢复  - 超时管理                         ││
│  └─────────────────────────────────────────────────────────────────────────┘│
├─────────────────────────────────────────────────────────────────────────────┤
│                           Data Collection Layer                              │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────────────────────┐ │
│  │ SourceRegistry │  │ ConfigDriven   │  │     Collector Implementations  │ │
│  │ - 数据源注册    │  │ Collector      │  │     - MarketCollectors         │ │
│  │ - 健康检查      │  │ - YAML配置驱动  │  │     - FundamentalCollectors    │ │
│  │ - 能力声明      │  │ - 字段映射      │  │     - ReportCollectors         │ │
│  └────────────────┘  └────────────────┘  └────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────────┤
│                           Data Processing Layer                              │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────────────────────┐ │
│  │ DataValidator  │  │ DataQuality    │  │     EntityProcessor            │ │
│  │ - Schema校验    │  │ Checker        │  │     - 实体识别                  │ │
│  │ - 业务规则      │  │ - 完整性检查    │  │     - 关系抽取                  │ │
│  │                │  │ - 准确性检查    │  │                                │ │
│  └────────────────┘  └────────────────┘  └────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────────┤
│                           Storage Layer                                      │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────────────────────┐ │
│  │ PostgreSQL     │  │ Redis Cache    │  │     Neo4j Graph                │ │
│  │ - 结构化数据    │  │ - 实时缓存      │  │     - 知识图谱                  │ │
│  │ - 因子数据      │  │ - 会话状态      │  │     - 实体关系                  │ │
│  └────────────────┘  └────────────────┘  └────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────────┤
│                           Data Service Layer                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                      UnifiedDataService                                  ││
│  │  ├── QuantDataService (行情/因子/资金流)                                  ││
│  │  └── GraphDataService (实体/关系/事件/新闻)                               ││
│  └─────────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、实施计划

### Phase 1: 核心抽象层增强 (预计3天)

**任务1.1: 完善数据接入规范**
- 创建 `pipeline/` 模块，统一数据管道抽象
- 定义 `DataSourceAdapter` 接口规范
- 实现 `PipelineBuilder` 流式构建器

**任务1.2: 增强DAG编排能力**
- 扩展 `TaskChainEngine` 支持可视化配置
- 添加 `PipelineRegistry` 管道注册中心
- 实现管道模板系统

**任务1.3: 数据质量框架**
- 创建 `quality/` 模块
- 实现 `DataQualityChecker` 质量检查器
- 添加数据血缘追踪能力

### Phase 2: 东方财富研报数据接入 (预计2天)

**任务2.1: 研报中心数据源适配器**
- 创建 `ResearchReportAdapter` 
- 实现研报元数据采集
- 实现研报内容解析

**任务2.2: 研报数据处理管道**
- 定义研报数据模型
- 实现研报实体抽取
- 实现研报情感分析

### Phase 3: 监控与可观测性 (预计2天)

**任务3.1: Prometheus指标暴露**
- 添加收集器性能指标
- 添加任务队列指标
- 添加数据质量指标

**任务3.2: 日志与追踪**
- 统一日志格式
- 添加分布式追踪支持
- 实现告警机制

### Phase 4: 测试与验证 (预计2天)

**任务4.1: 单元测试**
- 收集器测试
- 管道测试
- 数据质量测试

**任务4.2: 集成测试**
- 端到端数据流测试
- 性能压测
- 故障恢复测试

---

## 四、关键文件变更清单

### 新增文件
```
backend/openfinance/datacenter/
├── pipeline/
│   ├── __init__.py
│   ├── builder.py          # Pipeline构建器
│   ├── registry.py         # 管道注册中心
│   ├── adapter.py          # 数据源适配器基类
│   └── templates/          # 管道模板
│       ├── daily_collection.yaml
│       └── research_report.yaml
├── quality/
│   ├── __init__.py
│   ├── checker.py          # 数据质量检查器
│   ├── validator.py        # 数据校验器
│   └── lineage.py          # 数据血缘追踪
├── adapters/
│   ├── __init__.py
│   ├── research_report.py  # 东方财富研报适配器
│   └── base.py             # 适配器基类
└── monitoring/
    ├── __init__.py
    ├── metrics.py          # Prometheus指标
    └── alerts.py           # 告警配置
```

### 修改文件
```
backend/openfinance/datacenter/
├── task/chain_engine.py    # 增强DAG能力
├── core/config.py          # 扩展配置系统
├── service/data_service.py # 增强服务层
└── persistence.py          # 添加质量检查
```

---

## 五、预期收益

| 指标 | 当前 | 目标 | 提升 |
|------|------|------|------|
| 代码复用率 | 60% | 85% | +25% |
| 新数据源接入时间 | 2天 | 4小时 | -75% |
| 数据质量监控覆盖 | 30% | 90% | +60% |
| 任务失败恢复时间 | 30分钟 | 5分钟 | -83% |
| 管道可视化程度 | 0% | 100% | +100% |

---

确认后将按Phase顺序逐步实施。