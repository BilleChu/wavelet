# 数据模型统一架构设计方案

## 一、架构设计原则

### 1. 分层架构
```
┌─────────────────────────────────────────────────────────────┐
│                    API/Service Layer                         │
│         (请求/响应模型，对外接口，验证逻辑)                    │
├─────────────────────────────────────────────────────────────┤
│                    ADS Domain Layer                          │
│    (领域模型，业务逻辑，统一数据结构，一处定义多处复用)        │
│    ADSKLineModel, ADSFinancialModel, ADSShareholderModel... │
├─────────────────────────────────────────────────────────────┤
│                    ORM Persistence Layer                     │
│         (数据库表映射，SQLAlchemy 模型)                       │
│    StockDailyQuoteModel, StockFinancialIndicatorModel...    │
└─────────────────────────────────────────────────────────────┘
```

### 2. 核心原则
- **单一数据源**: ADS 模型是业务层的唯一数据结构定义
- **自动映射**: 通过 ModelRegistry 自动管理 ADS ↔ ORM 转换
- **统一命名**: 制定字段命名规范，消除不一致
- **可扩展性**: 新增数据类型只需定义 ADS 模型和 ORM 模型，注册映射即可

---

## 二、ADS 模型扩展计划

### 1. 新增模型清单

| 模型名称 | 说明 | 对应 ORM 模型 |
|----------|------|---------------|
| `ADSKLineModel` | K线数据 (已有) | StockDailyQuoteModel |
| `ADSFactorModel` | 因子数据 (已有) | FactorDataModel |
| `ADSSignalModel` | 交易信号 (已有) | - |
| `ADSMetaModel` | 元数据 (已有) | - |
| **`ADSFinancialIndicatorModel`** | 财务指标 | StockFinancialIndicatorModel |
| **`ADSBalanceSheetModel`** | 资产负债表 | (新建) |
| **`ADSIncomeStatementModel`** | 利润表 | (新建) |
| **`ADSCashFlowModel`** | 现金流量表 | (新建) |
| **`ADSShareholderModel`** | 股东情况 | (新建) |
| **`ADSMoneyFlowModel`** | 资金流向 | StockMoneyFlowModel |
| **`ADSMarketSentimentModel`** | 市场情绪 | (新建) |
| **`ADSNewsModel`** | 新闻数据 | NewsModel |
| **`ADSMacroEconomicModel`** | 宏观经济 | MacroEconomicModel |
| **`ADSOptionQuoteModel`** | 期权行情 | OptionQuoteModel |
| **`ADSFutureQuoteModel`** | 期货行情 | FutureQuoteModel |
| **`ADSStockBasicModel`** | 股票基本信息 | StockBasicModel |

### 2. 文件组织结构
```
backend/openfinance/datacenter/ads/
├── __init__.py              # 导出所有模型
├── base.py                  # 基础类和枚举
├── market/                  # 市场数据模型
│   ├── __init__.py
│   ├── kline.py            # K线数据
│   ├── money_flow.py       # 资金流向
│   ├── option.py           # 期权行情
│   └── future.py           # 期货行情
├── financial/               # 财务数据模型
│   ├── __init__.py
│   ├── indicator.py        # 财务指标
│   ├── balance_sheet.py    # 资产负债表
│   ├── income_statement.py # 利润表
│   └── cash_flow.py        # 现金流量表
├── shareholder/             # 股东数据模型
│   ├── __init__.py
│   ├── holder.py           # 股东持股
│   └── change.py           # 股东变动
├── sentiment/               # 情绪数据模型
│   ├── __init__.py
│   ├── market.py           # 市场情绪
│   └── news.py             # 新闻情绪
├── macro/                   # 宏观数据模型
│   ├── __init__.py
│   └── economic.py         # 宏观经济
├── quant/                   # 量化数据模型
│   ├── __init__.py
│   ├── factor.py           # 因子数据
│   └── signal.py           # 交易信号
└── meta/                    # 元数据模型
    ├── __init__.py
    └── metadata.py         # 数据元信息
```

---

## 三、统一字段命名规范

### 1. 时间字段
| 用途 | 统一命名 | 说明 |
|------|----------|------|
| 交易日期 | `trade_date` | date 类型 |
| 报告日期 | `report_date` | 财报日期 |
| 创建时间 | `created_at` | datetime 类型 |
| 更新时间 | `updated_at` | datetime 类型 |
| 采集时间 | `collected_at` | 数据入库时间 |

### 2. 比率字段
| 用途 | 统一命名 | 格式 |
|------|----------|------|
| 换手率 | `turnover_rate` | 百分比 (0.05 = 5%) |
| 涨跌幅 | `change_pct` | 百分比 |
| 振幅 | `amplitude` | 百分比 |
| ROE | `roe` | 百分比 |

### 3. 值字段
| 用途 | 统一命名 | 说明 |
|------|----------|------|
| 因子值 | `value` | 原始值 |
| 标准化值 | `value_normalized` | z-score |
| 排名 | `rank` | 整数 |
| 百分位 | `percentile` | 0-100 |

---

## 四、ModelRegistry 映射配置

### 1. 映射注册示例
```python
from openfinance.datacenter.models.framework import ModelRegistry

registry = ModelRegistry.get_instance()

# K线数据映射
registry.register(
    model_class=ADSKLineModel,
    category="market",
    model_id="kline",
    orm_model=StockDailyQuoteModel,
    field_mappings={
        "turnover_rate": "turnover",  # ORM -> ADS
        "collected_at": "updated_at",
    },
)

# 财务指标映射
registry.register(
    model_class=ADSFinancialIndicatorModel,
    category="financial",
    model_id="financial_indicator",
    orm_model=StockFinancialIndicatorModel,
    field_mappings={},
)
```

### 2. 自动转换工具
```python
class ModelTransformer:
    """自动模型转换器"""
    
    def orm_to_ads(orm_obj, ads_class: type) -> ADSModel:
        """ORM 对象转 ADS 模型"""
        metadata = registry.get_metadata(ads_class.__name__)
        field_mappings = metadata.field_mappings
        
        data = {}
        for orm_field, ads_field in field_mappings.items():
            data[ads_field] = getattr(orm_obj, orm_field)
        
        return ads_class(**data)
```

---

## 五、实施步骤

### Phase 1: 基础架构重构
1. 重构 ADS 模型目录结构
2. 创建基础类和枚举 (`base.py`)
3. 迁移现有模型到新目录

### Phase 2: 财务数据模型
1. 实现 `ADSFinancialIndicatorModel`
2. 实现 `ADSBalanceSheetModel`
3. 实现 `ADSIncomeStatementModel`
4. 实现 `ADSCashFlowModel`
5. 创建对应 ORM 模型（如不存在）

### Phase 3: 股东与情绪模型
1. 实现 `ADSShareholderModel`
2. 实现 `ADSMarketSentimentModel`
3. 实现 `ADSNewsModel` (增强版)

### Phase 4: 映射与转换
1. 完善所有模型的 Registry 注册
2. 实现 `ModelTransformer` 自动转换
3. 更新 Repository 使用自动转换

### Phase 5: 清理与文档
1. 删除重复的 Business 模型
2. 统一字段命名
3. 编写使用文档和示例

---

## 六、预期成果

1. **统一的数据模型**: 所有业务数据通过 ADS 模型定义
2. **自动映射转换**: ORM ↔ ADS 自动转换，无需手动编写
3. **清晰的架构层次**: API → ADS → ORM，职责分明
4. **良好的扩展性**: 新增数据类型只需定义模型并注册
5. **消除重复代码**: 删除 Business 模型目录，避免维护多套模型