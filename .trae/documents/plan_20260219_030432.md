# 数据模型管理模块优化设计方案

## 一、架构设计原则

### 1.1 分层原则
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        业务逻辑层 (Business Logic Layer)                      │
│  职责：业务规则、业务流程、业务模型定义                                          │
│  特点：高内聚，按业务域划分                                                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐  │
│  │ QuantBusiness   │  │ GraphBusiness   │  │    MarketBusiness           │  │
│  │ - 因子计算规则    │  │ - 实体识别规则    │  │    - 行情分析规则            │  │
│  │ - 策略逻辑       │  │ - 关系抽取规则    │  │    - 资金流分析              │  │
│  │ - 回测引擎       │  │ - 图谱构建       │  │                             │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────────────────┤
│                        数据架构层 (Data Architecture Layer)                   │
│  职责：数据模型管理、转换、存储、传输 - 通用框架                                 │
│  特点：低耦合，可复用，框架级                                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐  │
│  │ ModelRegistry   │  │ ModelTransformer │  │    SchemaManager            │  │
│  │ - 模型注册中心    │  │ - 通用转换引擎    │  │    - Schema管理             │  │
│  │ - 版本管理       │  │ - 字段映射       │  │    - 验证规则               │  │
│  │ - 能力声明       │  │ - 类型转换       │  │    - 兼容性检查              │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────────────────┤
│                        数据存储层 (Data Storage Layer)                        │
│  职责：数据持久化、缓存、索引 - 基础设施                                        │
│  特点：无业务逻辑，纯技术实现                                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐  │
│  │ PostgreSQL      │  │ Redis Cache     │  │    Neo4j Graph              │  │
│  │ - ORM映射       │  │ - 缓存策略       │  │    - 图存储                 │  │
│  │ - 事务管理       │  │ - 会话管理       │  │    - 关系查询               │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 高内聚低耦合设计

| 层级 | 内聚方式 | 耦合控制 |
|------|----------|----------|
| 业务逻辑层 | 按业务域聚合 | 仅依赖数据架构层接口 |
| 数据架构层 | 按功能聚合 | 不依赖业务逻辑，提供抽象接口 |
| 数据存储层 | 按技术聚合 | 不依赖上层，实现标准接口 |

---

## 二、数据架构层详细设计（通用框架）

### 2.1 核心组件

```python
# openfinance/datacenter/models/framework/__init__.py

"""
数据架构框架 - 通用数据模型管理

设计原则：
1. 框架不包含任何业务逻辑
2. 所有业务模型通过注册方式接入
3. 提供标准化的模型生命周期管理
"""

from .registry import ModelRegistry, ModelMetadata
from .transformer import ModelTransformer, FieldMapping
from .schema import SchemaManager, SchemaDefinition
from .versioning import VersionManager, ModelVersion
from .validation import DataValidator, ValidationRule
```

### 2.2 模型注册中心（通用）

```python
# openfinance/datacenter/models/framework/registry.py

class ModelRegistry:
    """
    通用模型注册中心
    
    职责：
    - 模型注册与发现
    - 模型元数据管理
    - 模型能力声明
    
    特点：
    - 不依赖具体业务模型
    - 支持任意Pydantic/SQLAlchemy模型
    - 提供插件式扩展
    """
    
    _instance = None
    
    def __init__(self):
        self._models: dict[str, ModelMetadata] = {}
        self._categories: dict[str, list[str]] = {}
        self._transformers: dict[tuple[str, str], ModelTransformer] = {}
    
    def register(
        self,
        model_class: type,
        category: str,
        model_id: str | None = None,
        version: str = "1.0.0",
        orm_model: type | None = None,
        schema: dict | None = None,
    ) -> ModelMetadata:
        """
        注册模型
        
        Args:
            model_class: Pydantic模型类
            category: 业务分类（如 "quant", "graph", "market"）
            model_id: 模型唯一标识
            version: 模型版本
            orm_model: 对应的ORM模型
            schema: JSON Schema定义
        """
        pass
    
    def get_model(self, model_id: str, version: str | None = None) -> type:
        """获取模型类"""
        pass
    
    def get_metadata(self, model_id: str) -> ModelMetadata:
        """获取模型元数据"""
        pass
    
    def list_models(self, category: str | None = None) -> list[ModelMetadata]:
        """列出模型"""
        pass
    
    def register_transformer(
        self,
        source_model_id: str,
        target_model_id: str,
        transformer: ModelTransformer,
    ) -> None:
        """注册模型转换器"""
        pass
```

### 2.3 模型转换器（通用）

```python
# openfinance/datacenter/models/framework/transformer.py

class FieldMapping(BaseModel):
    """字段映射配置"""
    source_field: str
    target_field: str
    transform: str | None = None  # 转换函数名
    default: Any | None = None

class ModelTransformer(Generic[S, T]):
    """
    通用模型转换器
    
    职责：
    - Pydantic ↔ Pydantic 转换
    - Pydantic ↔ SQLAlchemy 转换
    - 字段映射与类型转换
    
    特点：
    - 配置驱动，无硬编码
    - 支持自定义转换函数
    - 支持嵌套对象转换
    """
    
    def __init__(
        self,
        source_type: type[S],
        target_type: type[T],
        field_mappings: list[FieldMapping],
    ):
        self.source_type = source_type
        self.target_type = target_type
        self.field_mappings = {m.source_field: m for m in field_mappings}
    
    def transform(self, source: S) -> T:
        """执行转换"""
        pass
    
    def transform_batch(self, sources: list[S]) -> list[T]:
        """批量转换"""
        pass
    
    @classmethod
    def auto_create(
        cls,
        source_type: type,
        target_type: type,
    ) -> "ModelTransformer":
        """自动创建转换器（基于字段名匹配）"""
        pass
```

### 2.4 Schema管理器（通用）

```python
# openfinance/datacenter/models/framework/schema.py

class SchemaDefinition(BaseModel):
    """Schema定义"""
    schema_id: str
    version: str
    json_schema: dict
    created_at: datetime
    deprecated: bool = False

class SchemaManager:
    """
    Schema管理器
    
    职责：
    - JSON Schema管理
    - Schema版本控制
    - 数据验证
    """
    
    def register_schema(
        self,
        schema_id: str,
        json_schema: dict,
        version: str = "1.0.0",
    ) -> SchemaDefinition:
        """注册Schema"""
        pass
    
    def validate(
        self,
        data: dict,
        schema_id: str,
        version: str | None = None,
    ) -> ValidationResult:
        """验证数据"""
        pass
    
    def get_schema(self, schema_id: str) -> SchemaDefinition:
        """获取Schema"""
        pass
```

---

## 三、业务逻辑层设计（按域划分）

### 3.1 业务模型定义规范

```python
# openfinance/datacenter/models/business/__init__.py

"""
业务模型定义

每个业务域独立目录：
- quant/     量化分析域
- graph/     知识图谱域
- market/    市场数据域
- agent/     Agent域
"""

from .quant import register_quant_models
from .graph import register_graph_models
from .market import register_market_models
```

### 3.2 量化分析域模型

```python
# openfinance/datacenter/models/business/quant/__init__.py

from openfinance.datacenter.models.framework import ModelRegistry

def register_quant_models(registry: ModelRegistry):
    """注册量化分析域模型"""
    
    # 因子数据模型
    registry.register(
        model_class=FactorData,
        category="quant",
        model_id="factor_data",
        orm_model=FactorDataModel,
        schema={
            "type": "object",
            "properties": {
                "factor_id": {"type": "string"},
                "code": {"type": "string"},
                "trade_date": {"type": "string", "format": "date"},
                "value": {"type": "number"},
            },
            "required": ["factor_id", "code", "trade_date", "value"],
        },
    )
    
    # 回测结果模型
    registry.register(
        model_class=BacktestResult,
        category="quant",
        model_id="backtest_result",
        schema={...},
    )
```

### 3.3 市场数据域模型

```python
# openfinance/datacenter/models/business/market/__init__.py

from openfinance.datacenter.models.framework import ModelRegistry

def register_market_models(registry: ModelRegistry):
    """注册市场数据域模型"""
    
    # 股票行情模型
    registry.register(
        model_class=StockQuoteData,
        category="market",
        model_id="stock_quote",
        orm_model=StockDailyQuoteModel,
        schema={...},
    )
    
    # 资金流向模型
    registry.register(
        model_class=MoneyFlowData,
        category="market",
        model_id="money_flow",
        orm_model=StockMoneyFlowModel,
        schema={...},
    )
```

---

## 四、数据管道集成设计

### 4.1 Collector层集成

```python
# openfinance/datacenter/collector/core/base_collector.py

class BaseCollector(ABC, Generic[T]):
    """数据收集器基类"""
    
    def __init__(
        self,
        config: CollectionConfig,
        model_id: str | None = None,
    ):
        self.config = config
        self.model_id = model_id
        self._registry = ModelRegistry.get_instance()
    
    async def collect(self) -> CollectionResult[T]:
        """收集数据，返回强类型结果"""
        data = await self._collect()
        
        # 如果指定了模型ID，自动验证和转换
        if self.model_id:
            validated_data = self._validate_and_transform(data)
            return CollectionResult(data=validated_data)
        
        return CollectionResult(data=data)
    
    def _validate_and_transform(self, data: list[dict]) -> list[T]:
        """验证并转换数据"""
        model_class = self._registry.get_model(self.model_id)
        return [model_class(**item) for item in data]
```

### 4.2 Persistence层集成

```python
# openfinance/datacenter/persistence.py

class DataPersistence:
    """数据持久化"""
    
    def __init__(self):
        self._registry = ModelRegistry.get_instance()
    
    async def save(
        self,
        data: list[Any],
        model_id: str,
    ) -> int:
        """
        通用保存方法
        
        自动完成：
        1. 获取模型元数据
        2. 获取ORM模型
        3. 转换数据
        4. 执行存储
        """
        metadata = self._registry.get_metadata(model_id)
        
        if not metadata.orm_model:
            raise ValueError(f"No ORM model for {model_id}")
        
        transformer = self._registry.get_transformer(
            model_id,
            metadata.orm_model.__name__,
        )
        
        orm_data = transformer.transform_batch(data)
        
        return await self._batch_insert(orm_data, metadata.orm_model)
```

### 4.3 Service层集成

```python
# openfinance/datacenter/service/data_service.py

class UnifiedDataService:
    """统一数据服务"""
    
    def __init__(self):
        self._registry = ModelRegistry.get_instance()
    
    async def query(
        self,
        model_id: str,
        filters: dict | None = None,
        limit: int | None = None,
    ) -> list[Any]:
        """查询数据"""
        metadata = self._registry.get_metadata(model_id)
        
        # 查询ORM数据
        orm_data = await self._query_orm(metadata.orm_model, filters, limit)
        
        # 转换为业务模型
        transformer = self._registry.get_transformer(
            metadata.orm_model.__name__,
            model_id,
        )
        
        return transformer.transform_batch(orm_data)
```

---

## 五、统一枚举管理

```python
# openfinance/models/enums.py

"""
统一枚举定义

原则：
1. 所有枚举集中定义
2. 按业务域分组
3. 提供枚举注册机制
"""

from enum import Enum

# ============ 数据采集域 ============
class DataSource(str, Enum):
    EASTMONEY = "eastmoney"
    JINSHI = "jinshi"
    TUSHARE = "tushare"
    # ...

class DataType(str, Enum):
    STOCK_QUOTE = "stock_quote"
    FINANCIAL_INDICATOR = "financial_indicator"
    # ...

# ============ 量化分析域 ============
class FactorType(str, Enum):
    TECHNICAL = "technical"
    FUNDAMENTAL = "fundamental"
    # ...

# ============ 知识图谱域 ============
class EntityType(str, Enum):
    COMPANY = "company"
    INDUSTRY = "industry"
    # ...

class RelationType(str, Enum):
    BELONGS_TO = "belongs_to"
    HAS_CONCEPT = "has_concept"
    # ...

# ============ 枚举注册 ============
ENUM_REGISTRY: dict[str, type[Enum]] = {
    "DataSource": DataSource,
    "DataType": DataType,
    "FactorType": FactorType,
    "EntityType": EntityType,
    "RelationType": RelationType,
}
```

---

## 六、实施计划

### Phase 1: 创建数据架构框架 (预计2小时)
- 创建 `models/framework/` 目录
- 实现 `ModelRegistry` 通用注册中心
- 实现 `ModelTransformer` 通用转换器
- 实现 `SchemaManager` Schema管理器

### Phase 2: 统一枚举定义 (预计1小时)
- 创建 `models/enums.py`
- 整合所有重复枚举
- 建立枚举注册机制

### Phase 3: 业务模型注册 (预计2小时)
- 创建 `models/business/` 目录结构
- 按域注册业务模型
- 配置模型映射关系

### Phase 4: 数据管道集成 (预计2小时)
- Collector集成模型验证
- Persistence集成模型转换
- Service集成模型查询

### Phase 5: 更新Skill文档 (预计1小时)
- 添加模型管理规范
- 添加模型注册流程

---

## 七、新增文件清单

```
backend/openfinance/
├── models/
│   └── enums.py                    # 统一枚举定义
├── datacenter/
│   └── models/
│       ├── __init__.py
│       ├── framework/              # 数据架构框架（通用）
│       │   ├── __init__.py
│       │   ├── registry.py         # 模型注册中心
│       │   ├── transformer.py      # 模型转换器
│       │   ├── schema.py           # Schema管理
│       │   ├── versioning.py       # 版本管理
│       │   └── validation.py       # 数据验证
│       └── business/               # 业务模型定义
│           ├── __init__.py
│           ├── quant/              # 量化分析域
│           ├── graph/              # 知识图谱域
│           └── market/             # 市场数据域
```

---

## 八、预期收益

| 指标 | 优化前 | 优化后 | 说明 |
|------|--------|--------|------|
| 框架通用性 | 低 | 高 | 框架不依赖业务，可复用 |
| 业务内聚性 | 中 | 高 | 按域聚合，职责清晰 |
| 层间耦合度 | 高 | 低 | 通过接口解耦 |
| 新模型接入 | 修改多处 | 注册即可 | 零侵入接入 |
| 模型一致性 | 50% | 95% | 统一管理验证 |